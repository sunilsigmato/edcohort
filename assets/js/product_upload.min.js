var S_YX,S_Data;

$(function(){
    
    // File validation function
    $('body').on('change', "input.file-activity", function() {
        allocated =$('#reference_date');

        $excelFile =$('#excel_file');



        $t=$('.excel-bulk-upload-result');
        $t.hide();
        $t.find("table tbody tr").remove();
        $t.find(".excel-area").hide();
        $t.find(".excel-area h4 span").html("0");
        $('#submit_excel_data').addClass('.d-none');
        $('#viewExcelTbl').remove();
        S_YX =0;
        S_Data =0;
                    
                    $rx=$(this);
                   
                    yx=$rx.closest("form");
                    
                    // Compare extension
                    var fileExtension = ['xlsx'];
                    if ($.inArray($rx.val().split('.').pop().toLowerCase(), fileExtension) == -1) {
                        swal("","Only formats are allowed : "+fileExtension.join(', '),'error');
                        $rx.val("");
                        return;
                    }
                    // Compare file size
                    var fileSize = this.files[0].size/1024/1024;
                    if(fileSize>25)
                    {
                     var n = fileSize.toFixed(2);
                        swal('','Your file size is: ' + n + "MB, and it is too large to upload! Please try to upload smaller file (25MB or less).","error");
                        $rx.val("");
                        return;
            
                    }
                    
                    yx.find('.progress').show();
                    yx.find('.myprogress').css('width', '0');
                    yx.find('.myprogress').css("background-color","#FFC107");
                    
                    var formData = new FormData();
                    formData.append('prd_file', $rx[0].files[0]);
                    leaveUploadPage();
                    
                    
                    $.ajax({
                        url: base_url+"admin_product/import_ajax_save",
                        data: formData,
                        processData: false,
                        contentType: false,
                        type: 'POST',
                        
                        // this part is progress bar
                        xhr: function () {
                            var xhr = new window.XMLHttpRequest();
                            xhr.upload.addEventListener("progress", function (evt) {
                                if (evt.lengthComputable) {
                                    var percentComplete = evt.loaded / evt.total;
                                    percentComplete = parseInt(percentComplete * 100);
                                    yx.find('.myprogress').text("Uploading.."+percentComplete + '%');
                                    yx.find('.myprogress').css('width', percentComplete + '%');
                                }
                            }, false);
                            return xhr;
                        },
                        success: function (data) {
                            if(data.error=="1"){
                              //  swal("",data.msg,"error");
                                yx.find('.progress').hide();
                            }else{
                                
                                call_processing_area(yx,data);
                                //
                            }
                        },
                        error: function(xhr, result, errorThrown){
                            swal("","Failed to process your request. Please try again.","error");
                        }
        });
    });
   
    function activate_submit(yx,data){
        yx.find('.myprogress').css("background-color","#2196F3");
        yx.find('.progress').hide();
        
        
        createViewTable(yx,data)
    }
    
    
    
    $('body').on('click', "#submit_excel_data", function() {
        if(S_YX  && S_Data){
            $(this).attr('disabled','disabled');
            
       
                               items=$('#frmProductEImport').serialize() 
                               + '&'+ $.param({
                                file:S_Data.json,
                               ajax:1,
                               total:S_Data.total,processed:0});
                               
                                validate_and_processs_to_db(S_YX,items);
        }else{
            swal("","No valid excel data found. Please upload file.","error");
        }
    });
    
    
    function createViewTable(yx,data){
         $.getJSON(base_url+data.json, function (data) {

            var arrItems = [];      // THE ARRAY TO STORE JSON ITEMS.
            $.each(data, function (index, value) {
                arrItems.push(value);       // PUSH THE VALUES INSIDE THE ARRAY.
            });

            // EXTRACT VALUE FOR TABLE HEADER.
            var col = ['Brand'];;
            
            

            // CREATE DYNAMIC TABLE.
            var table = document.createElement("table");
            table.className ='table table-bordered';
            table.id = 'viewExcelTbl';

            // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

            var tr = table.insertRow(-1);                   // TABLE ROW.

            for (var i = 0; i < col.length; i++) {
                var th = document.createElement("th");      // TABLE HEADER.
                th.innerHTML = col[i];
                tr.appendChild(th);
            }

            // ADD JSON DATA TO THE TABLE AS ROWS.
            
            for (var i = 0; i < arrItems.length; i++) {

                tr = table.insertRow(-1);

                for (var j = 0; j < col.length; j++) {
                    var tabCell = tr.insertCell(-1);
                    if(typeof(arrItems[i][j])!='undefined')
                    tabCell.innerHTML = arrItems[i][j];
                    else
                    tabCell.innerHTML = '';
                }
            }
            
            $('#submit_excel_data').before(table);
            $('#submit_excel_data').prop('disabled',false);
            $('#submit_excel_data').removeClass('d-none');
            $('#viewExcelTbl').remove(); // Dispay uploaded Vales
        });
    }
    
      //leaveUploadPage();
    function leaveUploadPage(str){
        window.onbeforeunload = function(){
          return (typeof(str)=="undefined" ? 'Please wait changes not saved.' : '');
        };
    }
    
    function call_processing_area(yx,res){
        yx.find('.myprogress').text("Processing your data..");
        yx.find('.myprogress').css('width', '100%');
       // console.log(res);
        $.ajax({
                        url: base_url+"admin_product/read_excel_values",
                        data: {ajax:1,
                        file_path:res.file_path,
                        full_path:res.full_path,
                        },
                        type: 'POST',
        success: function (data) {
                            if(data.error=="1"){
                                swal('',data.msg,"error");
                                yx.find('.progress').hide();
                            }else{
                                if(data.total > 10000)
                                {
                                    alert("Maximum 10,000 Rows At a Time");
                                    location.reload();
                                }
                                else
                                {
                                    S_YX =yx;
                                    S_Data = data;
                                    activate_submit(yx,data);
                                }
                            }
                            
                        },
                        error: function(xhr, result, errorThrown){
                            swal("","Failed to process your request. Please try again.","error");
                        }
        });
                        
    }
    
    function validate_and_processs_to_db(yx,data){
        yx.find('.myprogress').text("Processing your data "+data.processed+"/"+data.total);
        yx.find('.myprogress').css('width', '100%');
        
         $.ajax({
                        url: base_url+"admin_product/push_excel_values_db",
                        data:data,
                        type: 'POST',
        success: function (res) {
                            
                            if(data.error=="1"){
                                swal('',res.msg,"error");
                                yx.find('.progress').hide();
                                
                            }else{
                                excel_html_handler(res);
                                 if(res.page !="0")
                                {
                                  
                                    items=$('#frmProductEImport').serialize() 
                               + '&'+ $.param({
                                        
                                        file:res.file,
                                        ajax:1,
                                        total:res.total,
                                        page:res.page,
                                        processed:res.processed,
                                        validation_failed_total:res.validation_failed.total,
                                        employee_duplicates_total:res.employee_duplicates.total,
                                        salelement_duplicates_total:res.salelement_duplicates.total,
                                        present_duplicates_total:res.present_duplicates.total,
                                        imported_total:res.imported.total
                                    });
                                    validate_and_processs_to_db(yx,items);
                                    
                                }else{
                                    console.log(res);  
                                    yx.find('.myprogress').text("Processing Done.");
                                    yx.find('.myprogress').css('width', '100%');
                                    yx.find('.myprogress').css("background-color","#5cb85c");
                                    setTimeout( function(){yx.find(".progress").hide();} , 3000);

                                    $("#excel_file").val("");
                                    $('#submit_excel_data').addClass('d-none');
                                    $('#viewExcelTbl').remove();
                                    S_YX =0;
                                    S_Data =0;

                                    window.onbeforeunload = null;
                                }
                            }
                            
                            
                        },
                        error: function(xhr, result, errorThrown){
                            $('#submit_excel_data').prop('disabled',false);
                            swal("","Failed to process your request. Please try again.","error");
                        }
        });
    }
    
    function excel_html_handler(data){
        $t=$('.excel-bulk-upload-result');
        $t.show();
        
        $t.find(".e-b-im span").html(data.imported.total);
        $t.find(".e-b-im em").html(data.total);
        
        // Handle validation
        if(data.validation_failed.total > 0){
            $(".e-b-v-area").show();
            $(".e-b-v span").html(data.validation_failed.total);
            insert_values_to_db($(".e-b-v-area").find(".e-b-v-t"),data.validation_failed.data);
        }
        
        // Handle employee Duplicates
        if(data.product_duplicates.total > 0){
            $(".e-b-p-area").show();
            $(".e-b-p span").html(data.product_duplicates.total);
            insert_values_to_db($(".e-b-p-area").find(".e-b-p-t"),data.product_duplicates.data);
        }
        if(data.imported.total > 0){
            $(".e-b-im-area").show();
            $(".e-b-im span").html(data.imported.total);
            insert_values_to_db($(".e-b-im-area").find(".e-b-p-i"),data.imported.data);
        }
        
        
        // Handle Product Barcode Duplicates
        if(data.present_duplicates.total > 0){
            $(".e-b-d-area").show();
            $(".e-b-d span").html(data.present_duplicates.total);
            insert_values_to_db($(".e-b-d-area").find(".e-b-d-t"),data.present_duplicates.data);
        }
        

    }
    
    function insert_values_to_db($t,data){
            $.each( data, function( i, val ) {
               // $rowdata= "<tr><td>"+i+"</td><td>"+val+"</td><td>"+val;
                $rowdata = "<tr><td>" + i + "</td><td>" + val.join('</td><td>') + "</td></tr>";
                $t.find("tbody").append($rowdata);
            });
             $t.toggle();
    }
    
    $('body').on('click', ".e-b-opener", function() {
        $sl=$(this);
        $t=$sl.closest(".excel-area").find("table");
        $t.toggle();
        return false;
    });
    $('body').on('click', ".e-b-opener-imported", function() {
        $sl=$(this);
        $t=$sl.closest(".excel-area").find("table");
        $t.toggle();
        return false;
    });
    
    function format_data(val,key=''){
        if(typeof(val) == 'object'){
            return val[key];
        }
        return val;
    }

    
     
});